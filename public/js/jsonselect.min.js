(function(p){function x(b){try{return JSON&&JSON.parse?JSON.parse(b):(new Function("return "+b))()}catch(a){m("ijs",a.message)}}function m(b,a){throw Error(A[b]+(a&&" in '"+a+"'"));}function l(b,a){a||(a=0);var c=B.exec(b.substr(a));if(c){var a=a+c[0].length,e;c[1]?e=[a," "]:c[2]?e=[a,c[0]]:c[3]?e=[a,o.typ,c[0]]:c[4]?e=[a,o.psc,c[0]]:c[5]?e=[a,o.psf,c[0]]:c[6]?m("upc",b):c[8]?e=[a,c[7]?o.ide:o.str,x(c[8])]:c[9]?m("ujs",b):c[10]&&(e=[a,o.ide,c[10].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]);return e}}
function h(b,a){return typeof b===a}function s(b,a){var c,e=C.exec(b.substr(a));if(e)return a+=e[0].length,c=e[1]||e[2]||e[3]||e[5]||e[6],e[1]||e[2]||e[3]?[a,0,x(c)]:e[4]?[a,0,void 0]:[a,c]}function t(b,a){a||(a=0);var c=s(b,a),e;c&&"("===c[1]?(e=t(b,c[0]),c=s(b,e[0]),(!c||")"!==c[1])&&m("epex",b),a=c[0],e=["(",e[1]]):!c||c[1]&&"x"!=c[1]?m("ee",b+" - "+(c[1]&&c[1])):(e="x"===c[1]?void 0:c[2],a=c[0]);c=s(b,a);if(!c||")"==c[1])return[a,e];("x"==c[1]||!c[1])&&m("bop",b+" - "+(c[1]&&c[1]));var k=t(b,
c[0]),a=k[0],k=k[1],n;if("object"!==typeof k||"("===k[0]||q[c[1]][0]<q[k[1]][0])n=[e,c[1],k];else{for(n=k;"object"===typeof k[0]&&"("!=k[0][0]&&q[c[1]][0]>=q[k[0][1]][0];)k=k[0];k[0]=[e,c[1],k[0]]}return[a,n]}function D(b,a){function c(a){return"object"!==typeof a||null===a?a:"("===a[0]?c(a[1]):[c(a[0]),a[1],c(a[2])]}var e=t(b,a?a:0);return[e[0],c(e[1])]}function u(b,a){if(void 0===b)return a;if(null===b||"object"!==typeof b)return b;var c=u(b[0],a),e=u(b[2],a);return q[b[1]][1](c,e)}function v(b,
a,c,e){c||(e={});var k=[],n,j;for(a||(a=0);;){var f;f=b;var g=a,a=g,i={},d=l(f,g);d&&" "===d[1]&&(a=g=d[0],d=l(f,g));d&&d[1]===o.typ?(i.type=d[2],d=l(f,g=d[0])):d&&"*"===d[1]&&(d=l(f,g=d[0]));for(;void 0!==d;){if(d[1]===o.ide)i.id&&m("nmi",d[1]),i.id=d[2];else if(d[1]===o.psc)(i.pc||i.pf)&&m("mpc",d[1]),":first-child"===d[2]?(i.pf=":nth-child",i.a=0,i.b=1):":last-child"===d[2]?(i.pf=":nth-last-child",i.a=0,i.b=1):i.pc=d[2];else if(d[1]===o.psf)":val"===d[2]||":contains"===d[2]?(i.expr=[void 0,":val"===
d[2]?"=":"*=",void 0],(d=l(f,d[0]))&&" "===d[1]&&(d=l(f,d[0])),(!d||"("!==d[1])&&m("pex",f),(d=l(f,d[0]))&&" "===d[1]&&(d=l(f,d[0])),(!d||d[1]!==o.str)&&m("sex",f),i.expr[2]=d[2],(d=l(f,d[0]))&&" "===d[1]&&(d=l(f,d[0])),(!d||")"!==d[1])&&m("epex",f)):":has"===d[2]?((d=l(f,d[0]))&&" "===d[1]&&(d=l(f,d[0])),(!d||"("!==d[1])&&m("pex",f),g=v(f,d[0],!0),d[0]=g[0],i.has||(i.has=[]),i.has.push(g[1])):":expr"===d[2]?(i.expr&&m("mexp",f),g=D(f,d[0]),d[0]=g[0],i.expr=g[1]):((i.pc||i.pf)&&m("mpc",f),i.pf=d[2],
(g=E.exec(f.substr(d[0])))||m("mepf",f),g[5]?(i.a=2,i.b="odd"===g[5]?1:0):g[6]?(i.a=0,i.b=parseInt(g[6],10)):(i.a=parseInt((g[1]?g[1]:"+")+(g[2]?g[2]:"1"),10),i.b=g[3]?parseInt(g[3]+g[4],10):0),d[0]+=g[0].length);else break;d=l(f,g=d[0])}a===g&&m("se",f);f=[g,i];k.push(f[1]);(f=l(b,a=f[0]))&&" "===f[1]&&(f=l(b,a=f[0]));if(!f)break;if(">"===f[1]||"~"===f[1])"~"===f[1]&&(e.usesSiblingOp=!0),k.push(f[1]),a=f[0];else if(","===f[1])void 0===n?n=[",",k]:n.push(k),k=[],a=f[0];else if(")"===f[1]){c||m("ucp",
f[1]);j=1;a=f[0];break}}c&&!j&&m("mcp",b);n&&n.push(k);var h;if(!c&&e.usesSiblingOp)if(b=n?n:k,","===b[0]){for(c=[","];h<b.length;h++)var p=y(p[h]),c=c.concat(","===p[0]?p.slice(1):p);h=c}else h=y(b);else h=n?n:k;return[a,h]}function y(b){for(var a=[],c,e=0;e<b.length;e++)if("~"===b[e]){if(2>e||">"!=b[e-2])c=b.slice(0,e-1),c=c.concat([{has:[[{pc:":root"},">",b[e-1]]]},">"]),c=c.concat(b.slice(e+1)),a.push(c);if(1<e){var k=">"===b[e-2]?e-3:e-2;c=b.slice(0,k);var h={},j;for(j in b[k])b[k].hasOwnProperty(j)&&
(h[j]=b[k][j]);h.has||(h.has=[]);h.has.push([{pc:":root"},">",b[e-1]]);c=c.concat(h,">",b.slice(e+1));a.push(c)}break}return e==b.length?b:1<a.length?[","].concat(a):a[0]}function z(b){return Array.isArray?Array.isArray(b):"[object Array]"===F.call(b)}function G(b,a,c,e,k){var h=[],j=">"===a[0]?a[1]:a[0],f=!0;if(j.type&&f){var f=j.type,g;null===b?g="null":(g=typeof b,"object"===g&&z(b)&&(g="array"));f=f===g}j.id&&(f=f&&j.id===c);f&&j.pf&&(":nth-last-child"===j.pf?e=k-e:e++,0===j.a?f=j.b===e:(c=(e-
j.b)%j.a,f=!c&&0<=e*j.a+j.b));if(f&&j.has){e=function(){throw 42;};for(c=0;c<j.has.length;c++){try{r(j.has[c],b,e)}catch(i){if(42===i)continue}f=!1;break}}f&&j.expr&&(f=u(j.expr,b));">"!==a[0]&&":root"!==a[0].pc&&h.push(a);f&&(">"===a[0]?2<a.length&&(f=!1,h.push(a.slice(2))):1<a.length&&(f=!1,h.push(a.slice(1))));return[f,h]}function r(b,a,c,e,h,m){for(var b=","===b[0]?b.slice(1):[b],j=[],f=!1,g=0,i=0,d,l,g=0;g<b.length;g++){l=G(a,b[g],e,h,m);l[0]&&(f=!0);for(i=0;i<l[1].length;i++)j.push(l[1][i])}if(j.length&&
"object"===typeof a)if(1<=j.length&&j.unshift(","),z(a))for(g=0;g<a.length;g++)r(j,a[g],c,void 0,g,a.length);else for(d in a)a.hasOwnProperty(d)&&r(j,a[d],c,d);f&&c&&c(a)}function w(b,a){if(a){var c;c=b.replace(/\?/g,function(){if(0===a.length)throw"too few parameters given";var b=a.shift();return"string"===typeof b?JSON.stringify(b):b});if(a.length)throw"too many parameters supplied";b=c}return{sel:v(b)[1],match:function(a){var b=[];r(this.sel,a,function(a){b.push(a)});return b},forEach:function(a,
b){return r(this.sel,a,b)}}}var F=Object.prototype.toString,A={bop:"binary operator expected",ee:"expression expected",epex:"closing paren expected ')'",ijs:"invalid json string",mcp:"missing closing paren",mepf:"malformed expression in pseudo-function",mexp:"multiple expressions not allowed",mpc:"multiple pseudo classes (:xxx) not allowed",nmi:"multiple ids not allowed",pex:"opening paren expected '('",se:"selector expected",sex:"string expected",sra:"string required after '.'",uc:"unrecognized char",
ucp:"unexpected closing paren",ujs:"unclosed json string",upc:"unrecognized pseudo class"},o={psc:1,psf:2,typ:3,str:4,ide:5},B=RegExp('^(?:([\\r\\n\\t\\ ]+)|([~*,>\\)\\(])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child|has|expr|val|contains))|(:\\w+)|(?:(\\.)?(\\"(?:[^\\\\\\"]|\\\\[^\\"])*\\"))|(\\")|\\.((?:[_a-zA-Z]|[^\\0-\\0177]|\\\\[^\\r\\n\\f0-9a-fA-F])(?:[$_a-zA-Z0-9\\-]|[^\\u0000-\\u0177]|(?:\\\\[^\\r\\n\\f0-9a-fA-F]))*))'),
E=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,C=RegExp('^\\s*(?:(true|false|null)|(-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)|("(?:[^\\]|\\[^"])*")|(x)|(&&|\\|\\||[\\$\\^<>!\\*]=|[=+\\-*/%<>])|([\\(\\)]))'),q={"*":[9,function(b,a){return b*a}],"/":[9,function(b,a){return b/a}],"%":[9,function(b,a){return b%a}],"+":[7,function(b,a){return b+a}],"-":[7,function(b,a){return b-a}],"<=":[5,function(b,a){return h(b,"number")&&h(a,"number")&&b<=a||h(b,"string")&&
h(a,"string")&&b<=a}],">=":[5,function(b,a){return h(b,"number")&&h(a,"number")&&b>=a||h(b,"string")&&h(a,"string")&&b>=a}],"$=":[5,function(b,a){return h(b,"string")&&h(a,"string")&&b.lastIndexOf(a)===b.length-a.length}],"^=":[5,function(b,a){return h(b,"string")&&h(a,"string")&&0===b.indexOf(a)}],"*=":[5,function(b,a){return h(b,"string")&&h(a,"string")&&-1!==b.indexOf(a)}],">":[5,function(b,a){return h(b,"number")&&h(a,"number")&&b>a||h(b,"string")&&h(a,"string")&&b>a}],"<":[5,function(b,a){return h(b,
"number")&&h(a,"number")&&b<a||h(b,"string")&&h(a,"string")&&b<a}],"=":[3,function(b,a){return b===a}],"!=":[3,function(b,a){return b!==a}],"&&":[2,function(b,a){return b&&a}],"||":[1,function(b,a){return b||a}]};p._lex=l;p._parse=v;p.match=function(b,a,c){c||(c=a,a=void 0);return w(b,a).match(c)};p.forEach=function(b,a,c,e){e||(e=c,c=a,a=void 0);return w(b,a).forEach(c,e)};p.compile=w})("undefined"===typeof exports?window.JSONSelect={}:exports);
